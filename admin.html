<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CampusTap — Admin Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-green-700 min-h-screen text-gray-900">

<nav class="bg-white shadow p-4 flex justify-between">
  <div class="font-bold text-green-700">CampusTap — Admin</div>
  <button id="logoutBtn" class="bg-red-600 text-white px-3 py-1 rounded">Logout</button>
</nav>

<main class="max-w-6xl mx-auto p-6 space-y-6">

<section class="bg-white p-4 rounded shadow">
  <h2 class="text-green-700 font-semibold mb-3">Search User & Top Up</h2>

  <input id="emailSearch" class="w-full border px-3 py-2 rounded mb-3" placeholder="Search by email">

  <button id="searchBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Search</button>

  <div id="userCard" class="mt-4 p-4 border rounded hidden">
    <p><b>Name:</b> <span id="uName"></span></p>
    <p><b>Email:</b> <span id="uEmail"></span></p>
    <p><b>Balance:</b> ₱<span id="uBalance"></span></p>

    <label class="block mt-3">Amount to Add</label>
    <input id="topupAmount" class="w-full border px-3 py-2 rounded mb-2" type="number">
    <button id="topupBtn" class="bg-green-600 text-white px-4 py-2 rounded mb-3">Top Up</button>

    <label class="block">Assign RFID Tag</label>
    <input id="rfidInput" class="w-full border px-3 py-2 rounded mb-2" placeholder="From ride logs">
    <button id="saveRfidBtn" class="bg-purple-600 text-white px-4 py-2 rounded">Save RFID</button>
  </div>
</section>

<section class="bg-white p-4 rounded shadow">
  <h2 class="text-green-700 font-semibold mb-3">Ride Logs</h2>

  <div class="border rounded" style="max-height:300px; overflow:auto;">
    <table class="w-full text-sm">
      <thead class="bg-green-700 text-white sticky top-0">
        <tr>
          <th class="p-2 text-left">Date</th>
          <th class="p-2 text-left">RFID</th>
          <th class="p-2 text-left">Route</th>
          <th class="p-2 text-left">Fare</th>
        </tr>
      </thead>
      <tbody id="adminRidesTbody"></tbody>
    </table>
  </div>
</section>

</main>

<script type="module">
import { auth, db, rtdb } from "./firebase-config.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
import { collection, query, where, getDocs, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
import { ref, onValue } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";

let currentUserId = null;

onAuthStateChanged(auth, user => {
  if (!user) location.href = "index.html";
});

logoutBtn.onclick = () => signOut(auth);

// SEARCH USER
searchBtn.onclick = async () => {
  const email = emailSearch.value.trim();
  const q = query(collection(db, "users"), where("email", "==", email));
  const snap = await getDocs(q);

  if (snap.empty) return alert("User not found.");

  const userDoc = snap.docs[0];
  const data = userDoc.data();

  currentUserId = userDoc.id;
  uName.textContent = data.fullName;
  uEmail.textContent = data.email;
  uBalance.textContent = data.balance;

  userCard.classList.remove("hidden");
};

// TOP UP
topupBtn.onclick = async () => {
  if (!currentUserId) return alert("Search first.");

  const amount = Number(topupAmount.value);
  if (!amount || amount <= 0) return alert("Enter valid amount.");

  const userRef = doc(db, "users", currentUserId);
  const snap = await getDocs(query(collection(db, "users"), where("__name__", "==", currentUserId)));
  const data = snap.docs[0].data();

  const newBal = (data.balance || 0) + amount;

  await updateDoc(userRef, { balance: newBal });
  uBalance.textContent = newBal;

  alert("Balance updated.");
};

// SAVE RFID
saveRfidBtn.onclick = async () => {
  if (!currentUserId) return alert("Search first.");
  const rfid = rfidInput.value.trim();
  if (!rfid) return alert("Enter RFID");

  await updateDoc(doc(db, "users", currentUserId), { rfidTag: rfid });

  alert("RFID saved.");
};

// LOAD ALL RIDE LOGS
const ridesRef = ref(rtdb, "rides");
onValue(ridesRef, snap => {
  const tbody = document.getElementById("adminRidesTbody");
  tbody.innerHTML = "";

  const list = [];

  snap.forEach(child => list.push(child.val()));

  list.sort((a,b)=>b.timestamp - a.timestamp);

  for (const r of list) {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="p-2">${new Date(r.timestamp).toLocaleString()}</td>
      <td class="p-2">${r.uid}</td>
      <td class="p-2">${r.route}</td>
      <td class="p-2">₱${r.fare}</td>
    `;
    tbody.appendChild(row);
  }
});
</script>

</body>
</html>

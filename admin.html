<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>CampusTap — Admin</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-green-700 min-h-screen text-gray-900">
  <nav class="bg-white shadow p-4 flex justify-between items-center">
    <div class="font-bold text-green-700">Admin Dashboard</div>
    <div>
      <a href="campustap.html" class="text-green-700 mr-4">Student</a>
      <a href="account.html" class="text-green-700 mr-4">Account</a>
      <button id="logout" class="bg-red-600 text-white px-3 py-1 rounded">Logout</button>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto p-6 space-y-6">
    <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold text-green-700">Total Rides</h3>
        <canvas id="ridesChart"></canvas>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold text-green-700">Total Revenue</h3>
        <canvas id="revenueChart"></canvas>
      </div>
      <div class="bg-white p-4 rounded shadow">
        <h3 class="font-semibold text-green-700">Active Shuttles</h3>
        <canvas id="shuttleChart"></canvas>
      </div>
    </section>

    <section class="bg-white p-4 rounded shadow">
      <h3 class="text-lg font-semibold text-green-700">Manage Accounts (Top Up)</h3>
      <div class="flex gap-2 my-2">
        <input id="searchInput" type="text" placeholder="Search name / email" class="border p-2 rounded w-96">
        <button id="refreshBtn" class="bg-blue-600 text-white px-3 py-1 rounded">Refresh</button>
      </div>

      <div class="overflow-auto">
        <table class="w-full text-sm">
          <thead class="bg-green-700 text-white sticky top-0">
            <tr><th class="p-2 text-left">Name</th><th class="p-2 text-left">Email</th><th class="p-2 text-left">Role</th><th class="p-2 text-left">Balance</th><th class="p-2 text-left">Top Up</th></tr>
          </thead>
          <tbody id="usersTbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { signOut, getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";
    import { collection, query, orderBy, onSnapshot, doc, updateDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    const usersTbody = document.getElementById("usersTbody");
    const searchInput = document.getElementById("searchInput");
    const refreshBtn = document.getElementById("refreshBtn");

    document.getElementById("logout").onclick = () => signOut(getAuth());

    onAuthStateChanged(getAuth(), async (user) => {
      if (!user) return location.href = "index.html";
      // Optional: check role is admin and redirect if not
      const meSnap = await (await import("https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js")).getDoc((await import("https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js")).doc(db, "users", user.uid));
      if (!meSnap.exists() || meSnap.data().role !== "admin") return location.href = "campustap.html";
      subscribeUsers();
      drawCharts();
    });

    function renderUsers(list) {
      usersTbody.innerHTML = "";
      list.forEach(u => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2">${u.fullName||"—"}</td>
          <td class="p-2">${u.email||"—"}</td>
          <td class="p-2">${u.role||"—"}</td>
          <td class="p-2 font-semibold">₱${u.balance||0}</td>
          <td class="p-2">
            <input id="amt-${u.id}" type="number" class="border rounded px-2 py-1 w-28" placeholder="Amount">
            <button data-top="${u.id}" class="bg-green-600 text-white px-2 py-1 rounded ml-2">Top Up</button>
          </td>
        `;
        usersTbody.appendChild(tr);
      });

      usersTbody.querySelectorAll("[data-top]").forEach(btn => {
        btn.onclick = async () => {
          const uid = btn.dataset.top;
          const input = document.getElementById("amt-"+uid);
          const amount = Number(input.value || 0);
          if (!amount || amount <= 0) return alert("Enter a positive amount");
          if (!confirm(`Top up ₱${amount} for this user?`)) return;
          try {
            const userRef = doc(db, "users", uid);
            // read current balance then update (could be transaction)
            const snap = (await getDocs(query(collection(db, "users")))).docs.find(d=>d.id===uid);
            const current = snap?.data()?.balance ?? 0;
            await updateDoc(userRef, { balance: current + amount });
            // log topup
            await (await import("https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js")).addDoc(collection(db, "topups"), {
              uid, amount, by: getAuth().currentUser.uid, timestamp: Date.now()
            });
            input.value = "";
            alert("Top up successful");
          } catch (e) { alert(e.message); }
        };
      });
    }

    function subscribeUsers() {
      const q = query(collection(db, "users"), orderBy("fullName"));
      onSnapshot(q, qs => {
        const arr = qs.docs.map(d=>({ id:d.id, ...d.data() }));
        const filtered = arr.filter(u => (`${u.fullName} ${u.email}`).toLowerCase().includes((searchInput.value||"").toLowerCase()));
        renderUsers(filtered);
      });
    }

    refreshBtn.onclick = () => subscribeUsers();

    // Charts (Total rides and revenue)
    async function drawCharts() {
      const ridesSnap = await getDocs(collection(db, "rides"));
      const rides = ridesSnap.docs.map(d=>d.data());
      const totalRides = rides.length;
      const totalRevenue = rides.reduce((s,r)=> s + (r.fare || 0), 0);

      new Chart(document.getElementById('ridesChart'), { type:'bar', data:{ labels:['Rides'], datasets:[{ label:'Total Rides', data:[totalRides] }] } });
      new Chart(document.getElementById('revenueChart'), { type:'doughnut', data:{ labels:['Revenue'], datasets:[{ data:[totalRevenue] }] } });
      const active = Math.min(3, (totalRides % 5) + 1);
      new Chart(document.getElementById('shuttleChart'), { type:'pie', data:{ labels:['Active','Inactive'], datasets:[{ data:[active,3-active] }] } });
    }
  </script>
</body>
</html>

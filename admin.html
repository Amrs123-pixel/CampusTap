<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CampusTap Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

  <!-- Load Firebase Config -->
  <script src="firebase-config.js"></script>
</head>

<body class="bg-green-700 min-h-screen text-white">

<!-- NAVBAR -->
<nav class="bg-white text-green-700 shadow p-4 flex justify-between">
  <h1 class="font-bold text-xl">CampusTap Admin Dashboard</h1>
  <button id="logoutBtn" class="bg-green-700 text-white px-4 py-1 rounded">Logout</button>
</nav>

<main class="max-w-5xl mx-auto p-6 bg-white text-gray-900 rounded shadow mt-6">

  <h2 class="text-xl font-bold text-green-700">Manage User Balances</h2>

  <div class="mt-4 bg-gray-100 p-4 rounded shadow">
    <label class="block">Select User</label>
    <select id="userSelect" class="border rounded p-2 w-full mt-1"></select>

    <label class="block mt-4">Top-Up Amount</label>
    <input id="topupAmount" type="number" min="1" class="border rounded p-2 w-full">

    <button id="topupBtn" class="bg-green-700 text-white px-4 py-2 mt-4 rounded w-full">Top Up</button>
  </div>

  <h2 class="text-xl font-bold text-green-700 mt-8">Recent Top-Ups</h2>
  <table class="w-full mt-2 border">
    <thead class="bg-green-700 text-white">
      <tr>
        <th class="p-2 border">User</th>
        <th class="p-2 border">Amount</th>
        <th class="p-2 border">Admin</th>
        <th class="p-2 border">Time</th>
      </tr>
    </thead>
    <tbody id="topupTable"></tbody>
  </table>

</main>

<script>
  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const auth = firebase.getAuth(app);
  const db = firebase.getFirestore(app);

  const userSelect = document.getElementById("userSelect");
  const topupAmount = document.getElementById("topupAmount");
  const topupBtn = document.getElementById("topupBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const topupTable = document.getElementById("topupTable");

  let currentAdmin = null;

  // ========== AUTH LISTENER ==========
  firebase.onAuthStateChanged(auth, user => {
    if (!user) {
      window.location = "index.html";
      return;
    }
    currentAdmin = user;
    loadUsers();
    loadRecentTopups();
  });

  // ========== LOAD USERS ==========
  async function loadUsers() {
    const usersRef = firebase.collection(db, "users");
    const snapshot = await firebase.getDocs(usersRef);

    userSelect.innerHTML = "";

    snapshot.forEach(doc => {
      const d = doc.data();
      const option = document.createElement("option");
      option.value = doc.id;
      option.textContent = `${d.fullName} â€” â‚±${d.balance ?? 0}`;
      userSelect.appendChild(option);
    });
  }

  // ========== LOAD TOP-UP HISTORY ==========
  async function loadRecentTopups() {
    topupTable.innerHTML = "";

    const q = firebase.query(
      firebase.collection(db, "topups"),
      firebase.orderBy("timestamp", "desc"),
      firebase.limit(10)
    );

    const snapshot = await firebase.getDocs(q);

    snapshot.forEach(doc => {
      const d = doc.data();
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td class="border p-2">${d.userEmail || d.userId}</td>
        <td class="border p-2">â‚±${d.amount}</td>
        <td class="border p-2">${d.adminEmail}</td>
        <td class="border p-2">${new Date(d.timestamp).toLocaleString()}</td>
      `;

      topupTable.appendChild(tr);
    });
  }

  // ============================================================
  // ðŸ”¥ UPDATED TOP-UP LOGIC â€” NOW SYNC USERS + RFIDUSERS
  // ============================================================

  topupBtn.onclick = async () => {
    const uid = userSelect.value;
    const amt = parseInt(topupAmount.value, 10);

    if (!uid) {
      alert("Select a user first.");
      return;
    }
    if (!amt || amt <= 0) {
      alert("Enter a valid top-up amount.");
      return;
    }

    try {
      const userRef = firebase.doc(db, "users", uid);
      const userSnap = await firebase.getDoc(userRef);

      if (!userSnap.exists()) {
        alert("User not found!");
        return;
      }

      const userData = userSnap.data();
      const currentBalance = userData.balance ?? 0;
      const newBalance = currentBalance + amt;
      const rfid = userData.rfid || null;

      // 1ï¸âƒ£ Update USERS balance
      await firebase.updateDoc(userRef, { balance: newBalance });

      // 2ï¸âƒ£ Update RFID USERS balance (if rfid exists)
      if (rfid) {
        const rfidRef = firebase.doc(db, "rfidUsers", rfid);
        await firebase.updateDoc(rfidRef, { balance: newBalance });
      }

      // 3ï¸âƒ£ Log the top-up
      await firebase.addDoc(firebase.collection(db, "topups"), {
        userId: uid,
        userEmail: userData.email || "",
        amount: amt,
        adminId: currentAdmin.uid,
        adminEmail: currentAdmin.email,
        timestamp: Date.now()
      });

      alert("Top-up successful!");

      topupAmount.value = "";
      await loadUsers();
      await loadRecentTopups();

    } catch (err) {
      console.error(err);
      alert("Top-up failed: " + err.message);
    }
  };

  // ========== LOGOUT ==========
  logoutBtn.onclick = async () => {
    await firebase.signOut(auth);
    window.location = "index.html";
  };
</script>

</body>
</html>

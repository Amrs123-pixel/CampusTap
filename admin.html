<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CampusTap Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-green-700 min-h-screen text-gray-900">
  <!-- NAVBAR -->
  <nav class="bg-white shadow p-4 flex justify-between">
    <h1 class="text-xl font-bold text-green-700">ðŸ“Š CampusTap Admin</h1>
    <a href="campustap.html" class="text-green-700 font-semibold">Back to Map</a>
  </nav>

  <main class="max-w-6xl mx-auto p-6 space-y-6">

    <!-- ============================= -->
    <!--   TOP ANALYTICS CHARTS        -->
    <!-- ============================= -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

      <!-- Total Rides -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-lg font-semibold text-green-700">Total Rides</h2>
        <canvas id="ridesChart"></canvas>
      </div>

      <!-- Revenue -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-lg font-semibold text-green-700">Total Revenue</h2>
        <canvas id="revenueChart"></canvas>
      </div>

      <!-- Active Shuttle -->
      <div class="bg-white p-4 rounded-lg shadow">
        <h2 class="text-lg font-semibold text-green-700">Active Shuttle</h2>
        <canvas id="shuttleChart"></canvas>
      </div>

    </div>

    <!-- ============================= -->
    <!--   MANAGE ACCOUNTS             -->
    <!-- ============================= -->
    <div class="bg-white p-5 rounded-lg shadow">
      <h2 class="text-lg font-semibold text-green-700 mb-3">ðŸ‘¥ Manage Student Accounts</h2>
      <table class="w-full border">
        <thead>
          <tr class="bg-green-700 text-white">
            <th class="p-2">Name</th>
            <th class="p-2">Email</th>
            <th class="p-2">Balance</th>
            <th class="p-2">Action</th>
          </tr>
        </thead>
        <tbody id="studentTable"></tbody>
      </table>
    </div>

    <!-- ============================= -->
    <!--   RECENT TOP-UPS              -->
    <!-- ============================= -->
    <div class="bg-white p-5 rounded-lg shadow">
      <h2 class="text-lg font-semibold text-green-700 mb-3">ðŸ’µ Recent Top-Ups</h2>
      <table class="w-full border">
        <thead>
          <tr class="bg-green-700 text-white">
            <th class="p-2">Student</th>
            <th class="p-2">Amount</th>
            <th class="p-2">Time</th>
          </tr>
        </thead>
        <tbody id="topupTable"></tbody>
      </table>
    </div>

  </main>

  <!-- ================= FIREBASE LOGIC ================= -->
  <script type="module">
    import { auth, db } from "./firebase-config.js";
    import { 
      getDocs, collection, doc, getDoc, updateDoc, addDoc, query, orderBy 
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "index.html";

      const snap = await getDoc(doc(db, "users", user.uid));
      if (!snap.exists() || snap.data().role !== "admin") {
        alert("Access denied: Admin only.");
        return location.href = "campustap.html";
      }

      loadStudents();
      loadTopUps();
      loadAnalytics();
    });

    /* ---------------- Load Students ---------------- */
    async function loadStudents() {
      const table = document.getElementById("studentTable");
      table.innerHTML = "";

      const q = await getDocs(collection(db, "users"));
      q.forEach(docu => {
        const u = docu.data();
        if (u.role !== "student") return;

        table.innerHTML += `
          <tr class="border-b">
            <td class="p-2">${u.fullName}</td>
            <td class="p-2">${u.email}</td>
            <td class="p-2">â‚±${u.balance}</td>
            <td class="p-2">
              <button class="bg-green-600 text-white px-3 py-1 rounded" onclick="topUp('${docu.id}', '${u.fullName}')">
                Top-Up
              </button>
            </td>
          </tr>
        `;
      });
    }

    /* ---------------- Top-Up System ---------------- */
    window.topUp = async function(uid, name) {
      let amount = prompt("Enter amount to add:");
      if (!amount) return;
      amount = parseInt(amount);

      const userRef = doc(db, "users", uid);
      const snap = await getDoc(userRef);
      const current = snap.data().balance;

      await updateDoc(userRef, { balance: current + amount });

      // save topup log
      await addDoc(collection(db, "topups"), {
        uid,
        name,
        amount,
        time: new Date().toLocaleString()
      });

      loadStudents();
      loadTopUps();
      loadAnalytics();
    };

    /* ---------------- Load Top-Ups ---------------- */
    async function loadTopUps() {
      const table = document.getElementById("topupTable");
      table.innerHTML = "";

      const q = await getDocs(query(collection(db, "topups"), orderBy("time", "desc")));

      q.forEach(t => {
        const d = t.data();
        table.innerHTML += `
          <tr class="border-b">
            <td class="p-2">${d.name}</td>
            <td class="p-2">â‚±${d.amount}</td>
            <td class="p-2">${d.time}</td>
          </tr>
        `;
      });
    }

    /* ---------------- Analytics (Charts) ---------------- */
    async function loadAnalytics() {
      // get all rides
      const rideSnap = await getDocs(collection(db, "rides"));
      let rideCount = 0;
      rideSnap.forEach(() => rideCount++);

      // revenue
      const revenue = rideCount * 10;

      // shuttle status
      const locSnap = await getDoc(doc(db, "shuttle", "shuttle1"));
      let active = 0;
      let inactive = 1;

      if (locSnap.exists()) {
        const last = locSnap.data().timestamp;
        const now = Date.now();

        if (now - last < 30000) active = 1;
        else inactive = 1;
      }

      /* Draw Total Rides Chart */
      new Chart(document.getElementById("ridesChart"), {
        type: "bar",
        data: {
          labels: ["Rides"],
          datasets: [{
            label: "Number of Rides",
            data: [rideCount],
            backgroundColor: "#16a34a"
          }]
        }
      });

      /* Revenue Chart */
      new Chart(document.getElementById("revenueChart"), {
        type: "doughnut",
        data: {
          labels: ["Revenue"],
          datasets: [{
            data: [revenue],
            backgroundColor: ["#22c55e"]
          }]
        }
      });

      /* Shuttle Chart */
      new Chart(document.getElementById("shuttleChart"), {
        type: "pie",
        data: {
          labels: ["Active", "Inactive"],
          datasets: [{
            data: [active, inactive],
            backgroundColor: ["#16a34a", "#86efac"]
          }]
        }
      });
    }
  </script>

</body>
</html>

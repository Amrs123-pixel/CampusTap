<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CampusTap â€” Login / Register</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-green-700 min-h-screen flex items-center justify-center">

  <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
    <h1 class="text-2xl font-bold text-green-700 mb-1">CampusTap</h1>
    <p class="text-xs text-gray-500 mb-6">
      USC shuttle tracking with RFID payment & real-time GPS
    </p>

    <!-- FULL NAME -->
    <label class="block text-sm font-semibold mb-1">Full name</label>
    <input id="fullName" type="text" class="w-full px-3 py-2 mb-3 border rounded" />

    <!-- EMAIL -->
    <label class="block text-sm font-semibold mb-1">Email</label>
    <input id="email" type="email" class="w-full px-3 py-2 mb-3 border rounded" />

    <!-- PASSWORD -->
    <label class="block text-sm font-semibold mb-1">Password</label>
    <input id="password" type="password" class="w-full px-3 py-2 mb-4 border rounded" />

    <!-- REGISTER -->
    <button id="registerBtn"
      class="w-full bg-green-600 text-white py-2 rounded-lg mb-3 hover:bg-green-700">
      Register
    </button>

    <!-- LOGIN -->
    <button id="loginBtn"
      class="w-full bg-blue-600 text-white py-2 rounded-lg mb-4 hover:bg-blue-700">
      Login
    </button>

    <div class="flex items-center my-4">
      <div class="flex-grow h-px bg-gray-300"></div>
      <span class="text-gray-500 px-2 text-sm">OR</span>
      <div class="flex-grow h-px bg-gray-300"></div>
    </div>

    <!-- GOOGLE LOGIN -->
    <button id="googleBtn"
      class="w-full border py-2 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-100">
      <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" />
      <span>Continue with Google</span>
    </button>

    <p class="text-xs text-center text-gray-500 mt-4">
      Admin accounts are auto-detected by USC emails (@usc.edu.ph). Others become students.
    </p>
  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { app, auth, db } from "./firebase-config.js";
    import {
      GoogleAuthProvider,
      signInWithPopup,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

    import {
      setDoc,
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // UI elements
    const fullName = document.getElementById("fullName");
    const email = document.getElementById("email");
    const password = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const googleBtn = document.getElementById("googleBtn");

    /*******************************
     * REGISTER (EMAIL/PASSWORD)
     *******************************/
    registerBtn.onclick = async () => {
      try {
        if (!fullName.value || !email.value || !password.value) {
          alert("Complete all fields first.");
          return;
        }

        const userCredential = await createUserWithEmailAndPassword(
          auth,
          email.value,
          password.value
        );

        const user = userCredential.user;

        const domain = user.email.split("@")[1];
        const role = domain === "usc.edu.ph" ? "admin" : "student";

        // Create Firestore user
        await setDoc(doc(db, "users", user.uid), {
          name: fullName.value,
          email: user.email,
          balance: 0,
          role: role,
          createdAt: Date.now()
        });

        window.location.href = "campustap.html";
      } catch (err) {
        alert("Registration failed: " + err.message);
        console.error(err);
      }
    };

    /*******************************
     * LOGIN (EMAIL/PASSWORD)
     *******************************/
    loginBtn.onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, email.value, password.value);
        window.location.href = "campustap.html";
      } catch (err) {
        alert("Login failed: " + err.message);
        console.error(err);
      }
    };

    /*******************************
     * GOOGLE LOGIN
     *******************************/
    const provider = new GoogleAuthProvider();

    googleBtn.onclick = async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // Check Firestore if user exists
        const ref = doc(db, "users", user.uid);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          const domain = user.email.split("@")[1];

          await setDoc(ref, {
            name: user.displayName || "Google User",
            email: user.email,
            balance: 0,
            role: domain === "usc.edu.ph" ? "admin" : "student",
            createdAt: Date.now()
          });
        }

        window.location.href = "campustap.html";
      } catch (err) {
        alert("Google login failed: " + err.message);
        console.error(err);
      }
    };
  </script>
</body>
</html>

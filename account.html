<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>CampusTap â€” Student Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
    }
  </style>
</head>

<body class="bg-green-700 min-h-screen">

  <!-- NAVBAR -->
  <nav class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-green-700">ðŸ‘¤ Student Dashboard</h1>
    <div class="space-x-4">
      <a href="campustap.html" class="text-green-700 font-semibold">Map</a>
      <a href="about.html" class="text-green-700 font-semibold">About</a>
      <button onclick="logout()" class="bg-red-600 text-white px-3 py-1 rounded">Logout</button>
    </div>
  </nav>

  <main class="max-w-4xl mx-auto p-6 space-y-8">

    <!-- STUDENT INFO -->
    <section class="card">
      <h2 class="text-xl font-bold text-green-700 mb-3">ðŸ“˜ Student Information</h2>

      <p><strong>Name:</strong> <span id="studentName"></span></p>
      <p><strong>Email:</strong> <span id="studentEmail"></span></p>
      <p><strong>Account Balance:</strong> <span id="studentBalance" class="font-bold text-green-700"></span></p>
    </section>

    <!-- RECENT TOP UPS -->
    <section class="card">
      <h2 class="text-xl font-bold text-green-700 mb-3">ðŸ’° Recent Top-Ups</h2>

      <table class="w-full text-left border">
        <thead>
          <tr class="bg-green-600 text-white">
            <th class="p-2">Amount</th>
            <th class="p-2">Date</th>
          </tr>
        </thead>
        <tbody id="topupTable"></tbody>
      </table>
    </section>

    <!-- RECENT RIDES -->
    <section class="card">
      <h2 class="text-xl font-bold text-green-700 mb-3">ðŸ§¾ Recent Ride History</h2>

      <table class="w-full text-left border">
        <thead>
          <tr class="bg-green-600 text-white">
            <th class="p-2">Route</th>
            <th class="p-2">Fare</th>
            <th class="p-2">Date</th>
          </tr>
        </thead>
        <tbody id="rideTable"></tbody>
      </table>
    </section>

  </main>


  <!-- FIREBASE -->
  <script type="module">
    import { auth, db } from "./firebase-config.js";

    import {
      doc,
      getDoc,
      collection,
      query,
      where,
      orderBy,
      limit,
      getDocs
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    import {
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";


    let currentUser = null;

    /* ------------------------------
       CHECK LOGIN
    ------------------------------ */
    onAuthStateChanged(auth, async (user) => {
      if (!user) return location.href = "index.html";

      currentUser = user;

      const snap = await getDoc(doc(db, "users", currentUser.uid));
      if (!snap.exists()) return alert("User profile missing!");

      const u = snap.data();

      document.getElementById("studentName").innerText = u.fullName;
      document.getElementById("studentEmail").innerText = u.email;
      document.getElementById("studentBalance").innerText = "â‚±" + u.balance;

      loadTopUps();
      loadRideHistory();
    });

    function logout() {
      signOut(auth);
    }

    /* ------------------------------
       LOAD RECENT TOP UPS
    ------------------------------ */
    async function loadTopUps() {
      const tbody = document.getElementById("topupTable");
      tbody.innerHTML = "";

      const q = query(
        collection(db, "topups"),
        where("userId", "==", currentUser.uid),
        orderBy("timestamp", "desc"),
        limit(15)
      );

      const snaps = await getDocs(q);

      snaps.forEach(t => {
        const d = t.data();
        const date = new Date(d.timestamp).toLocaleString();

        tbody.innerHTML += `
          <tr class="border-b">
            <td class="p-2">â‚±${d.amount}</td>
            <td class="p-2">${date}</td>
          </tr>
        `;
      });
    }

    /* ------------------------------
       LOAD RECENT RIDE HISTORY
    ------------------------------ */
    async function loadRideHistory() {
      const tbody = document.getElementById("rideTable");
      tbody.innerHTML = "";

      const q = query(
        collection(db, "rides"),
        where("userId", "==", currentUser.uid),
        orderBy("timestamp", "desc"),
        limit(15)
      );

      const snaps = await getDocs(q);

      snaps.forEach(r => {
        const d = r.data();
        const date = new Date(d.timestamp).toLocaleString();

        tbody.innerHTML += `
          <tr class="border-b">
            <td class="p-2">${d.route}</td>
            <td class="p-2">â‚±${d.fare}</td>
            <td class="p-2">${date}</td>
          </tr>
        `;
      });
    }

  </script>

</body>
</html>
